#!/usr/bin/env ruby

require 'net/http'
require 'json'
# require 'pry'
require 'faye/websocket'
require 'eventmachine'
# require 'byebug'

class Slack
  TOKEN = "xoxp-19007494517-19011474082-19007915220-205475775d"
  # TOKEN = "xoxb-19012836615-UXersvIAojrfXGYCHiuSu2ov"

  def real_time_session
    get('rtm.start')
  end

  def game_channels
    channel_list.select do |channel|
      channel['name'].match(/\Achess\-/)
    end
  end

  private

  def channel_list
    data = get('channels.list')
    data["channels"].map do |channel|
      slice('id', 'name', channel)
    end
  end

  def slice(*keys, hash)
    keys.map.with_object({}) do |key, slice|
      slice[key] = hash[key]
    end
  end

  def get(resource)
    uri = URI("https://slack.com/api/#{resource}?token=#{TOKEN}")
    response = Net::HTTP.get(uri)
    JSON.parse(response)
  end
end

class Session
  def initialize
    @slack = Slack.new
  end

  def run
    talky
  end

  def test_channel
    @slack.game_channels.last
  end
 
  def talky
    websocket.on :open do |event|
      p [:open]
      websocket.send({
        "type": 'message',
        "channel": test_channel["id"],
        'text': 'kunal was here and matthew watched'
      }.to_json)
    end

    websocket.on :message do |event|
      p [:message, event.data]
    end

    websocket.on :close do |event|
      p [:close, event.code, event.reason]
      reset
    end
  end

  private

  def websocket
    @websocket ||= Faye::WebSocket::Client.new(websocket_url)
  end

  def reset
    @websocket = nil
  end

  def websocket_url
    @slack.real_time_session["url"]
  end
end

EM.run { Session.new.run }
